\section{Advanced Topics}

\begin{frame}
\frametitle{Building SimpleITK}
\end{frame}

\begin{frame}
\frametitle{SimpleITK architecture}
\end{frame}

\subsection{Code Philosophy}
\begin{frame}{Code Philosophy}
\fontsize{36pt}{36pt}\selectfont
\center
\begin{center}
Code Philosophy
\end{center}
\end{frame}

\begin{frame}[fragile]
\frametitle{Filter Class Overview (C++)}
\lstcpp
\begin{lstlisting}
class SmoothingRecursiveGaussianImageFilter : (* \label{Declaration} *)
    public ImageFilter {
  typedef SmoothingRecursiveGaussianImageFilter Self; (* \label{Self} *)

  /** Default Constructor that takes no arguments
      and initializes default parameters */
  SmoothingRecursiveGaussianImageFilter(); (* \label{Constructor} *)

\end{lstlisting}
\begin{itemize}
  \item In line \ref{Declaration}, we declare a subclass of ImageFilter
  \item Line \ref{Self} creates a special typedef for use later
  \item The default constructor is line \ref{Constructor} (never any parameters)
\end{itemize}
\end{frame}


\begin{frame}[fragile]
\frametitle{Filter Class Overview (C++) Continued}
\lstcpp
\begin{lstlisting}
  /** Define the pixels types supported by this filter */
  typedef BasicPixelIDTypeList  PixelIDTypeList; (* \label{PixelIDTypeList} *)

\end{lstlisting}
\begin{itemize}
  \item Notice $PixelIDTypeList$ in line \ref{PixelIDTypeList}
  \item Used to instantiate ITK filters
  \item Determines valid input image types
  \item $BasicPixelIDTypeList$ expands to:
  \begin{itemize}
    \item $int8\_t$, $uint8\_t$
    \item $int16\_t$, $uint16\_t$
    \item $int32\_t$, $uint32\_t$
    \item $float$, $double$
  \end{itemize}
\end{itemize}
\end{frame}


\begin{frame}[fragile]
\frametitle{Filter Class Overview (C++) Continued}
\lstcpp
\begin{lstlisting}
  Self& SetSigma ( double t ) { ... return *this; }
  double GetSigma() { return this->m_Sigma; }

  Self& SetNormalizeAcrossScale ( bool t ) { ... }
  Self& NormalizeAcrossScaleOn() { ... }
  Self& NormalizeAcrossScaleOff() { ... }

  bool GetNormalizeAcrossScale() { ... }
\end{lstlisting}
\begin{itemize}
  \item Get/Set parameters
  \item Set methods always return $Self\&$ (more later)
  \item Generally, a direct mapping to ITK
  \item Boolean parameters generate $On$ and $Off$ methods
\end{itemize}
\end{frame}


\begin{frame}[fragile]
\frametitle{Filter Class Overview (C++) Continued}
\lstcpp
\begin{lstlisting}
  /** Name of this class */
  std::string GetName() const { ... }

  /** Print ourselves out */
  std::string ToString() const;
\end{lstlisting}
\begin{itemize}
  \item Return the name and description of the filter
\end{itemize}
\end{frame}


\begin{frame}[fragile]
\frametitle{Filter Class Overview (C++) Continued}
\lstcpp
\begin{lstlisting}
  /** Execute the filter on the input image */
  Image Execute ( const Image & );

  /** Execute the filter with parameters */
  Image Execute ( const Image &,
    double inSigma,
    bool inNormalizeAcrossScale );
};  /* End of class SmoothingRecursiveGaussian */

Image SmoothingRecursiveGaussian ( const Image& , (* \label{Function} *)
  double inSigma = 1.0,
  bool inNormalizeAcrossScale = false );

\end{lstlisting}
\begin{itemize}
  \item Run the filter on an image and return the result
  \item Notice extra function (line \ref{Function}), adds flexibility
  \item Drop $ImageFilter$ from class name to get function name
\end{itemize}

\end{frame}

\begin{frame}{Questions?}
\fontsize{36pt}{36pt}\selectfont
\center
\begin{center}
Questions?
\end{center}
\end{frame}



\begin{frame}
\frametitle{Using ITK with SimpleITK}
\end{frame}

\begin{frame}
\frametitle{Interfacing with OpenCV (or other libraries)}
\end{frame}

\begin{frame}[fragile]
\frametitle{To OpenCV}
Problem: Use SimpleITK from another image processing library

\texttt{./ToOpenCV input.png output.png}

Steps:
\begin{itemize}
\item Load image using SimpleITK
\item Convert to OpenCV
\item Filter using OpenCV
\item Save using OpenCV
\end{itemize}
\end{frame}


\begin{frame}[fragile]
\frametitle{ToOpenCV}
Starting code: \texttt{ToOpenCV/ToOpenCV.cxx}\\
Directory: \texttt{SimpleITK-MICCAI-2011-Tutorial/Examples/AdvancedTutorial}
\begin{lstlisting}
#include <SimpleITK.h>
#include <opencv2/opencv.hpp>

...
  itk::simple::Image sitkImage = itk::simple::ReadImage ( inputFilename );

  // Convert ITK to OpenCV image
  cv::Mat ocvImage;

  // Filter and write using OpenCV
  cv::Mat output;
  cv::medianBlur ( ocvImage, output, 5 );

  cv::imwrite ( outputFilename, output );
...
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{ToOpenCV -- Step 1}
Convert the SimpleITK image to a float
\begin{lstlisting}
  if ( sitkImage.GetPixelIDValue() != itk::simple::sitkFloat32 )
    {
    std::cout << "Input image is " << sitkImage.GetPixelIDTypeAsString()
              << " converting to float" << std::endl;
    sitkImage = itk::simple::Cast ( sitkImage, itk::simple::sitkFloat32 );
    }
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{ToOpenCV -- Step 2}
Get pixel data through the ITK image inside a SimpleITK image
\begin{lstlisting}
  // Go through ITK to grab the data
  typedef itk::Image<float,2> ImageType;
  ImageType::Pointer itkImage = (ImageType*)sitkImage.GetImageBase();

  // Convert ITK to OpenCV image
  cv::Mat ocvImage ( sitkImage.GetHeight(), sitkImage.GetWidth(), CV_32F,
                     (void*)itkImage->GetBufferPointer() );
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{ToOpenCV -- Step 3 (Optional)}
Display the before and after
\lstcppa
\begin{lstlisting}
// NB: the imshow function requires 8-bit data, so convert
cv::Mat temp;
ocvImage.convertTo ( temp, CV_8U );
cv::imshow ( "original slice", temp );
output.convertTo ( temp, CV_8U );
cv::imshow ( "bilateral filtering", temp );

std::cout << "Press any key to continue" << std::endl;
cv::waitKey();
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{To OpenCV and Back}
Problem: Use OpenCV to process a SimpleITK volume slice-by-slice

\texttt{./ToOpenCVAndBack input.nii output.nii}

Steps:
\begin{itemize}
\item Load image using SimpleITK
\item Extract slice
\item Convert to OpenCV
\item Filter using OpenCV
\item Past slice back to SimpleITK
\item Save result
\end{itemize}
\end{frame}


\begin{frame}[fragile]
\frametitle{To OpenCV and Back}
Starting code: \texttt{ToOpenCVAndBack/ToOpenCVAndBack.cxx}\\
Directory: \texttt{SimpleITK-MICCAI-2011-Tutorial/Examples/AdvancedTutorial}
\begin{lstlisting}
...
itk::simple::Image sitkImage = itk::simple::ReadImage ( inputFilename );

for ( unsigned int s = 0; s < sitkImage.GetDepth(); s++ )
  {
  // Extract a slice
  // Go through ITK to grab the data
  // Convert ITK to OpenCV image
  // Filter using OpenCV
  // Convert back to SimpleITK
  // Paste the image back into SimpleITK
  }
itk::simple::WriteImage ( sOutput, outputFilename );
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{To OpenCV and Back - Step 1: Extract a slice}
\begin{lstlisting}
// Extract a slice
std::vector<unsigned int> size = sitkImage.GetSize();
size[2] = 1;
std::vector<int> index ( 3, 0 );
index[2] = s;
std::cout << "Extracting: " << s << std::endl;
itk::simple::Image slice = itk::simple::RegionOfInterest ( sitkImage, size, index );

if ( slice.GetPixelIDValue() != itk::simple::sitkFloat32 )
  {
  slice = itk::simple::Cast ( slice, itk::simple::sitkFloat32 );
  }
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{To OpenCV and Back - Step 2: Get data via ITK}
\begin{lstlisting}
  // Go through ITK to grab the data
  typedef itk::Image<float,2> ImageType;
  ImageType::Pointer itkImage = (ImageType*)slice.GetImageBase();
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{To OpenCV and Back - Step 3: Convert to OpenCV}
\begin{lstlisting}
// Convert ITK to OpenCV image
  cv::Mat ocvImage ( slice.GetHeight(), slice.GetWidth(),
                     CV_32F,  (void*)itkImage->GetBufferPointer() );
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{To OpenCV and Back - Step 4: Filter using OpenCV}
\begin{lstlisting}
  // Filter using OpenCV
  cv::Mat output;
  cv::Sobel ( ocvImage, output, -1, 1, 1 );
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{To OpenCV and Back - Step 5: Back to SimpleITK}
\begin{lstlisting}
  // Convert back to SimpleITK
  itk::simple::ImportImageFilter importer;
  importer.SetSize ( size );
  importer.SetSpacing ( sitkImage.GetSpacing() );
  importer.SetOrigin ( sitkImage.GetOrigin() );
  importer.SetBufferAsFloat ( output.ptr<float>() );

  itk::simple::Image toSimpleITKImage = importer.Execute();
\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
\frametitle{To OpenCV and Back - Step 6: Paste back into SimpleITK volume}
\begin{lstlisting}
  // Paste the image back into SimpleITK
  // Paste ( Destination, Source, SourceSize, SourceIndex, DestIndex )
  sOutput = itk::simple::Paste ( sOutput, toSimpleITKImage,
            toSimpleITKImage.GetSize(), std::vector<int> ( 3,0 ), index );
\end{lstlisting}
\end{frame}

\begin{frame}
\frametitle{Extending SimpleITK}
JSON and friends
\end{frame}
